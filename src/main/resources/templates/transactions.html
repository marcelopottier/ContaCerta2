<!DOCTYPE html>
<html lang="pt-BR"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">Transações</title>

    <th:block layout:fragment="css">
        <style>
            .transaction-row {
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .transaction-row:hover {
                background-color: rgba(111, 66, 193, 0.05);
                transform: translateX(2px);
            }

            .transaction-type-badge {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                font-weight: bold;
            }

            .transaction-income {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border: 2px solid rgba(25, 135, 84, 0.2);
            }

            .transaction-expense {
                background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
                color: white;
                border: 2px solid rgba(220, 53, 69, 0.2);
            }

            .filters-card {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 1px solid #dee2e6;
            }

            .quick-filter-btn {
                transition: all 0.2s ease;
            }

            .quick-filter-btn.active {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .export-dropdown {
                min-width: 200px;
            }

            .card-header {
                background-color: #f8f9fa;
                border-bottom: 1px solid #dee2e6;
            }

            .card-header .card-title {
                color: #212529 !important;
                font-weight: 600;
            }

            .filter-section {
                background: white;
                border-radius: 0.375rem;
                padding: 1.5rem;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            }

            .filter-row {
                margin-bottom: 1rem;
            }

            .filter-row:last-child {
                margin-bottom: 0;
            }

            .search-section {
                background: #f8f9fa;
                border-radius: 0.375rem;
                padding: 1rem;
                margin-top: 1rem;
            }

            .form-control::placeholder {
                color: #6c757d;
                opacity: 1;
            }

            .form-select option[value=""] {
                color: #6c757d;
            }

            .filter-active-indicator {
                background-color: #0d6efd;
                color: white;
                border-radius: 50%;
                width: 8px;
                height: 8px;
                display: inline-block;
                margin-left: 5px;
            }

            @media (max-width: 768px) {
                .table-responsive {
                    font-size: 0.875rem;
                }

                .d-none-mobile {
                    display: none !important;
                }

                .mobile-transaction-card {
                    margin-bottom: 1rem;
                    border-left: 4px solid;
                }

                .mobile-transaction-card.income {
                    border-left-color: #198754;
                }

                .mobile-transaction-card.expense {
                    border-left-color: #dc3545;
                }

                .filter-section {
                    padding: 1rem;
                }
            }
        </style>
    </th:block>
</head>

<body>
<div layout:fragment="content">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-1 fw-bold text-dark">Transações</h1>
                <div th:if="${hasActiveFilters}" class="text-muted small">
                    <i class="bi bi-funnel-fill text-primary"></i>
                    Filtros ativos aplicados
                </div>
            </div>
            <button class="btn btn-primary" onclick="newTransaction()">
                <i class="bi bi-plus me-1"></i>Nova Transação
            </button>
        </div>

        <!-- Filters -->
        <div class="card filters-card mb-4">
            <div class="card-body">
                <div class="filter-section">
                    <form id="filterForm" th:action="@{/transactions}" method="get">
                        <!-- Hidden field para preservar página atual -->
                        <input type="hidden" name="page" value="0" id="pageInput">
                        <input type="hidden" name="size" th:value="${param.size != null ? param.size[0] : '10'}" id="sizeInput">
                        
                        <!-- Filtros Principais -->
                        <div class="row g-3 filter-row">
                            <!-- Date Range -->
                            <div class="col-md-2">
                                <label for="startDate" class="form-label fw-bold">
                                    <i class="bi bi-calendar me-1"></i><span class="fw-bold text-dark">Data Inicial</span>
                                    <span th:if="${param.startDate != null and param.startDate[0] != ''}" class="filter-active-indicator"></span>
                                </label>
                                <input type="date"
                                       class="form-control"
                                       id="startDate"
                                       name="startDate"
                                       th:value="${param.startDate != null ? param.startDate[0] : ''}">
                            </div>

                            <div class="col-md-2">
                                <label for="endDate" class="form-label fw-bold">
                                    <i class="bi bi-calendar-check me-1"></i><span class="fw-bold text-dark">Data Final</span>
                                    <span th:if="${param.endDate != null and param.endDate[0] != ''}" class="filter-active-indicator"></span>
                                </label>
                                <input type="date"
                                       class="form-control"
                                       id="endDate"
                                       name="endDate"
                                       th:value="${param.endDate != null ? param.endDate[0] : ''}">
                            </div>

                            <!-- Category Filter -->
                            <div class="col-md-2">
                                <label for="categoryFilter" class="form-label fw-bold">
                                    <i class="bi bi-tags me-1"></i><span class="fw-bold text-dark">Categoria</span>
                                    <span th:if="${param.categoryId != null and param.categoryId[0] != ''}" class="filter-active-indicator"></span>
                                </label>
                                <select class="form-select" id="categoryFilter" name="categoryId">
                                    <option value="">Todas as categorias</option>
                                    <option th:each="category : ${categories}"
                                            th:value="${category.id}"
                                            th:text="${category.name}"
                                            th:selected="${param.categoryId != null and param.categoryId[0] == category.id.toString()}">
                                        Categoria
                                    </option>
                                </select>
                            </div>

                            <!-- Type Filter -->
                            <div class="col-md-2">
                                <label for="typeFilter" class="form-label fw-bold">
                                    <i class="bi bi-arrow-left-right me-1"></i><span class="fw-bold text-dark">Tipo</span>
                                    <span th:if="${param.type != null and param.type[0] != ''}" class="filter-active-indicator"></span>
                                </label>
                                <select class="form-select" id="typeFilter" name="type">
                                    <option value="">Todos os tipos</option>
                                    <option value="ENTRADA" th:selected="${param.type != null and param.type[0] == 'ENTRADA'}">Entrada</option>
                                    <option value="SAIDA" th:selected="${param.type != null and param.type[0] == 'SAIDA'}">Saída</option>
                                </select>
                            </div>

                            <!-- Search -->
                            <div class="col-md-3">
                                <label for="search" class="form-label fw-bold">
                                    <i class="bi bi-search me-1"></i><span class="fw-bold text-dark">Descrição</span>
                                    <span th:if="${param.search != null and param.search[0] != ''}" class="filter-active-indicator"></span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="search"
                                       name="search"
                                       placeholder="Digite a descrição..."
                                       th:value="${param.search != null ? param.search[0] : ''}">
                            </div>

                            <!-- Action Buttons -->
                            <div class="col-md-1 d-flex flex-column justify-content-end">
                                <div class="btn-group-vertical w-100">
                                    <button class="btn btn-primary btn-sm" type="submit">
                                        <i class="bi bi-search me-1"></i>Filtrar
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-1" onclick="clearFilters()">
                                        <i class="bi bi-x me-1"></i>Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                        
                    <!-- Quick Filters -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label fw-bold mb-2">
                                <i class="bi bi-clock me-1"></i>Filtros Rápidos
                            </label>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-outline-secondary btn-sm quick-filter-btn" data-filter="today">Hoje</button>
                                <button class="btn btn-outline-secondary btn-sm quick-filter-btn" data-filter="week">Esta Semana</button>
                                <button class="btn btn-outline-secondary btn-sm quick-filter-btn" data-filter="month">Este Mês</button>
                                <button class="btn btn-outline-secondary btn-sm quick-filter-btn" data-filter="year">Este Ano</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Lista de Transações
                    <span class="badge bg-primary ms-2" th:if="${transactions != null}" th:text="${transactions.totalElements}">0</span>
                    <span th:if="${hasActiveFilters}" class="badge bg-secondary ms-1">
                        <i class="bi bi-funnel-fill"></i> Filtrado
                    </span>
                </h5>
                <div class="d-flex gap-2">
                    <!-- Export Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle btn-sm"
                                type="button"
                                data-bs-toggle="dropdown">
                            <i class="bi bi-download me-1"></i>Exportar
                        </button>
                        <ul class="dropdown-menu export-dropdown">
                            <li><h6 class="dropdown-header">Formato do Arquivo</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('excel')">
                                <i class="bi bi-file-earmark-excel text-success me-2"></i>Excel (.xlsx)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                                <i class="bi bi-file-earmark-text text-primary me-2"></i>CSV (.csv)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">
                                <i class="bi bi-file-earmark-pdf text-danger me-2"></i>PDF (.pdf)
                            </a></li>
                        </ul>
                    </div>

                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#transactionModal">
                        <i class="bi bi-plus me-1"></i>Nova Transação
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <!-- Desktop Table -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover mb-0" th:if="${transactions != null and !transactions.isEmpty()}">
                        <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 60px;">Tipo</th>
                            <th scope="col">Data</th>
                            <th scope="col">Descrição</th>
                            <th scope="col">Categoria</th>
                            <th scope="col" class="text-end">Valor</th>
                            <th scope="col" style="width: 120px;" class="text-center">Ações</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="transaction : ${transactions.content}"
                            class="transaction-row"
                            th:data-id="${transaction.id}">
                            <td>
                                <div th:class="${transaction.type.name() == 'ENTRADA' ? 'transaction-type-badge transaction-income' : 'transaction-type-badge transaction-expense'}">
                                    <i th:class="${transaction.type.name() == 'ENTRADA' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                </div>
                            </td>
                            <td>
                                <span th:text="${#temporals.format(transaction.date, 'dd/MM/yyyy')}">Data</span>
                                <br>
                                <small class="text-muted" th:text="${#temporals.format(transaction.date, 'EEEE', #locale)}"
                                       style="text-transform: capitalize;">Dia da semana</small>
                            </td>
                            <td>
                                <div class="fw-bold" th:text="${transaction.description ?: 'Sem descrição'}">Descrição</div>
                                <small class="text-muted" th:if="${transaction.description != null and #strings.length(transaction.description) > 50}">
                                    <span th:text="${#strings.abbreviate(transaction.description, 50)}">Descrição abreviada</span>
                                </small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border" th:text="${transaction.categoryName ?: 'Sem categoria'}">Categoria</span>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold fs-6"
                                      th:classappend="${transaction.type.name() == 'ENTRADA' ? 'text-success' : 'text-danger'}"
                                      th:text="${(transaction.type.name() == 'ENTRADA' ? '+' : '-') + #numbers.formatCurrency(transaction.value)}">
                                    Valor
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary btn-sm edit-btn"
                                            th:data-id="${transaction.id}"
                                            data-bs-toggle="tooltip"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-btn"
                                            th:data-id="${transaction.id}"
                                            th:data-description="${transaction.description ?: 'Sem descrição'}"
                                            data-bs-toggle="tooltip"
                                            title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="d-md-none p-3">
                    <div th:each="transaction : ${transactions.content}"
                         th:class="${'card mobile-transaction-card ' + (transaction.type.name() == 'ENTRADA' ? 'income' : 'expense')}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <div th:class="${transaction.type.name() == 'ENTRADA' ? 'transaction-type-badge transaction-income me-3' : 'transaction-type-badge transaction-expense me-3'}">
                                        <i th:class="${transaction.type.name() == 'ENTRADA' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold" th:text="${transaction.description ?: 'Sem descrição'}">Descrição</div>
                                        <small class="text-muted" th:text="${#temporals.format(transaction.date, 'dd/MM/yyyy')}">Data</small>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item edit-btn" href="#" th:data-id="${transaction.id}">
                                            <i class="bi bi-pencil me-2"></i>Editar
                                        </a></li>
                                        <li><a class="dropdown-item text-danger delete-btn" href="#"
                                               th:data-id="${transaction.id}"
                                               th:data-description="${transaction.description ?: 'Sem descrição'}">
                                            <i class="bi bi-trash me-2"></i>Excluir
                                        </a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-dark" th:text="${transaction.categoryName ?: 'Sem categoria'}">Categoria</span>
                                <span class="fw-bold"
                                      th:classappend="${transaction.type.name() == 'ENTRADA' ? 'text-success' : 'text-danger'}"
                                      th:text="${(transaction.type.name() == 'ENTRADA' ? '+' : '-') + #numbers.formatCurrency(transaction.value)}">
                                    Valor
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${transactions == null or transactions.isEmpty()}"
                     class="text-center py-5">
                    <i class="bi bi-receipt text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">
                        <span th:if="${hasActiveFilters}">Nenhuma transação encontrada com os filtros aplicados</span>
                        <span th:unless="${hasActiveFilters}">Nenhuma transação encontrada</span>
                    </h4>
                    <p class="text-muted">
                        <span th:if="${hasActiveFilters}">Tente ajustar os filtros ou</span>
                        <span th:unless="${hasActiveFilters}">Adicione algumas transações para começar</span>
                    </p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button th:if="${hasActiveFilters}" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-funnel me-1"></i>Limpar Filtros
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transactionModal">
                            <i class="bi bi-plus me-1"></i>
                            <span th:if="${hasActiveFilters}">Nova Transação</span>
                            <span th:unless="${hasActiveFilters}">Adicionar primeira transação</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div th:if="${transactions != null and transactions.totalPages > 1}" class="card-footer">
                <nav aria-label="Navegação de páginas">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item" th:classappend="${transactions.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/transactions(page=${transactions.number - 1}, size=${transactions.size}, startDate=${param.startDate}, endDate=${param.endDate}, categoryId=${param.categoryId}, type=${param.type}, search=${param.search})}">
                                <i class="bi bi-chevron-left"></i> Anterior
                            </a>
                        </li>

                        <li th:each="pageNum : ${#numbers.sequence(0, transactions.totalPages - 1)}"
                            class="page-item"
                            th:classappend="${pageNum == transactions.number} ? 'active'">
                            <a class="page-link"
                               th:href="@{/transactions(page=${pageNum}, size=${transactions.size}, startDate=${param.startDate}, endDate=${param.endDate}, categoryId=${param.categoryId}, type=${param.type}, search=${param.search})}"
                               th:text="${pageNum + 1}">1</a>
                        </li>

                        <li class="page-item" th:classappend="${transactions.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/transactions(page=${transactions.number + 1}, size=${transactions.size}, startDate=${param.startDate}, endDate=${param.endDate}, categoryId=${param.categoryId}, type=${param.type}, search=${param.search})}">
                                Próxima <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div th:replace="~{fragments/transaction-modal :: transaction-modal}"></div>
    <script>
        console.log('=== TESTE: Script da página transactions carregado ===');
        console.log('Modal existe?', !!document.getElementById('transactionModal'));
    </script>
    <!-- Confirm Delete Modal -->
    <div th:replace="~{fragments/components :: confirm-modal}"></div>
</div>

<th:block layout:fragment="javascript">
    <script>
        console.log('=== INÍCIO DO SCRIPT TRANSACTIONS ===');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - transactions.html');
            setupQuickFilters();
            setupTableInteractions();
            setupFormFilters();
            setupTransactionForm();

            // Testar carregamento de categorias
            console.log('Testando carregamento de categorias...');
            loadCategoriesForModal();
        });

        // Setup do formulário de transação
        function setupTransactionForm() {
            const form = document.getElementById('transactionForm');
            const modal = document.getElementById('transactionModal');

            if (!form) {
                console.warn('Formulário de transação não encontrado');
                return;
            }

            // Definir data padrão como hoje
            const dateInput = document.getElementById('transactionDate');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            // Event listener para submit do form
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

                const formData = new FormData(form);
                const data = {
                    type: formData.get('type'),
                    value: parseFloat(formData.get('value')),
                    date: formData.get('date'),
                    categoryId: parseInt(formData.get('categoryId')),
                    description: formData.get('description') || null
                };

                const isEdit = formData.get('id');
                const url = isEdit ? `/api/transactions/${isEdit}` : '/api/transactions';
                const method = isEdit ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value || ''
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        bootstrap.Modal.getInstance(modal).hide();

                        if (typeof FinanceApp !== 'undefined' && FinanceApp.ui) {
                            const message = isEdit ? 'Transação atualizada!' : 'Transação criada!';
                            FinanceApp.ui.showAlert(message, 'success');
                        }

                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        const error = await response.text();
                        alert('Erro ao salvar: ' + error);
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro de conexão');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });

            // Reset form when modal is hidden
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    form.reset();
                    form.classList.remove('was-validated');

                    // Reset date to today
                    if (dateInput) {
                        dateInput.value = new Date().toISOString().split('T')[0];
                    }
                });
            }
        }

        // Função para carregar categorias na modal
        async function loadCategoriesForModal() {
            console.log('=== loadCategoriesForModal executada ===');

            const select = document.getElementById('transactionCategory');
            console.log('Select encontrado:', !!select);

            if (!select) {
                console.error('Select transactionCategory não encontrado!');
                return;
            }

            // Mostrar estado de carregamento
            select.innerHTML = '<option value="">Carregando categorias...</option>';
            select.disabled = true;

            try {
                console.log('Fazendo requisição para /api/categories');

                const response = await fetch('/api/categories', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response:', {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const categories = await response.json();
                console.log('Categorias recebidas:', categories);

                select.innerHTML = '<option value="">Escolha uma categoria</option>';

                if (categories && Array.isArray(categories) && categories.length > 0) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;

                        // Adicionar cor como data attribute
                        if (category.color) {
                            option.setAttribute('data-color', category.color);
                            option.style.color = category.color;
                        }

                        select.appendChild(option);
                    });
                    console.log(`${categories.length} categorias adicionadas ao select`);
                } else {
                    select.innerHTML = '<option value="" disabled>Nenhuma categoria encontrada</option>';
                    console.warn('Nenhuma categoria retornada');
                }

            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                select.innerHTML = '<option value="" disabled>Erro ao carregar categorias</option>';

                // Se for erro de autenticação, redirecionar
                if (error.message.includes('401') || error.message.includes('403')) {
                    alert('Sessão expirada. Redirecionando para login...');
                    window.location.href = '/login';
                }
            } finally {
                select.disabled = false;
            }
        }

        // Função para editar transação
        window.editTransaction = async function(id) {
            console.log('Editando transação:', id);

            // Garantir que as categorias estão carregadas
            await loadCategoriesForModal();

            try {
                const response = await fetch(`/api/transactions/${id}`);
                if (!response.ok) throw new Error('Erro ao carregar transação');

                const transaction = await response.json();
                console.log('Dados da transação:', transaction);

                // Preencher formulário
                document.getElementById('transactionId').value = transaction.id;
                document.getElementById('transactionType').value = transaction.type;
                document.getElementById('transactionValue').value = transaction.value;
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionCategory').value = transaction.categoryId || transaction.category?.id;
                document.getElementById('transactionDescription').value = transaction.description || '';

                // Alterar título da modal
                const modalTitle = document.querySelector('#transactionModal .modal-title');
                if (modalTitle) {
                    modalTitle.innerHTML = '<i class="bi bi-pencil-square me-2"></i>Editar Transação';
                }

                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
                modal.show();

            } catch (error) {
                console.error('Erro ao editar transação:', error);
                alert('Erro ao carregar dados da transação: ' + error.message);
            }
        }

        // Função para nova transação
        window.newTransaction = function() {
            // Reset title
            const modalTitle = document.querySelector('#transactionModal .modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nova Transação';
            }

            // Garantir que as categorias estão carregadas
            loadCategoriesForModal();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            modal.show();
        }

        function setupFormFilters() {
            // Auto-submit form when filters change
            const filterElements = ['categoryFilter', 'typeFilter'];

            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        // Reset to first page when filtering
                        document.getElementById('pageInput').value = '0';
                        document.getElementById('filterForm').submit();
                    });
                }
            });

            // Submit form on Enter for search field
            const searchField = document.getElementById('search');
            if (searchField) {
                searchField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('pageInput').value = '0';
                        document.getElementById('filterForm').submit();
                    }
                });
            }

            // Auto-submit on date change
            const dateFields = ['startDate', 'endDate'];
            dateFields.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        document.getElementById('pageInput').value = '0';
                        document.getElementById('filterForm').submit();
                    });
                }
            });
        }

        function setupQuickFilters() {
            document.querySelectorAll('.quick-filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    const now = new Date();
                    let startDate, endDate;

                    switch(filter) {
                        case 'today':
                            startDate = endDate = formatDate(now);
                            break;
                        case 'week':
                            const weekStart = new Date(now);
                            weekStart.setDate(now.getDate() - now.getDay());
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            startDate = formatDate(weekStart);
                            endDate = formatDate(weekEnd);
                            break;
                        case 'month':
                            startDate = formatDate(new Date(now.getFullYear(), now.getMonth(), 1));
                            endDate = formatDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                            break;
                        case 'year':
                            startDate = formatDate(new Date(now.getFullYear(), 0, 1));
                            endDate = formatDate(new Date(now.getFullYear(), 11, 31));
                            break;
                    }

                    document.getElementById('startDate').value = startDate;
                    document.getElementById('endDate').value = endDate;

                    // Clear other filters when using quick filters
                    document.getElementById('categoryFilter').value = '';
                    document.getElementById('typeFilter').value = '';
                    document.getElementById('search').value = '';

                    // Mark as active
                    document.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Reset to first page and submit
                    document.getElementById('pageInput').value = '0';
                    document.getElementById('filterForm').submit();
                });
            });
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function setupTableInteractions() {
            // Row click to edit
            document.querySelectorAll('.transaction-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (!e.target.closest('button')) {
                        const id = this.dataset.id;
                        editTransaction(id);
                    }
                });
            });

            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    editTransaction(id);
                });
            });

            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    const description = this.dataset.description;
                    deleteTransaction(id, description);
                });
            });
        }

        function clearFilters() {
            // Clear all form fields
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('search').value = '';

            // Remove active state from quick filters
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

            // Reset pagination and redirect to clean URL
            window.location.href = '/transactions';
        }

        function deleteTransaction(id, description) {
            if (typeof FinanceApp !== 'undefined' && FinanceApp.ui) {
                FinanceApp.ui.showConfirmModal(
                    `Tem certeza que deseja excluir a transação "${description}"?`,
                    async function() {
                        try {
                            const response = await FinanceApp.http.delete(`/api/transactions/${id}`);

                            if (response && response.ok) {
                                FinanceApp.ui.showAlert('Transação excluída com sucesso!', 'success');
                                setTimeout(() => window.location.reload(), 1000);
                            } else {
                                const error = await response.text();
                                FinanceApp.ui.showAlert('Erro ao excluir transação: ' + error, 'danger');
                            }
                        } catch (error) {
                            FinanceApp.ui.showAlert('Erro de conexão. Tente novamente.', 'danger');
                        }
                    },
                    'Excluir Transação'
                );
            } else {
                // Fallback se FinanceApp não estiver disponível
                if (confirm(`Tem certeza que deseja excluir a transação "${description}"?`)) {
                    fetch(`/api/transactions/${id}`, { method: 'DELETE' })
                        .then(() => window.location.reload())
                        .catch(error => alert('Erro ao excluir transação'));
                }
            }
        }

        function exportData(format) {
            const params = new URLSearchParams(window.location.search);
            params.append('export', format);
            window.open(`/transactions/export?${params.toString()}`, '_blank');
        }

        // Teste manual
        window.testCategories = function() {
            console.log('=== TESTE MANUAL ===');
            loadCategoriesForModal();
        }

        console.log('=== SCRIPT TRANSACTIONS CARREGADO ===');
    </script>
</th:block>
</body>
</html>