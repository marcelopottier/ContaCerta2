<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Transaction Modal Fragment -->
<div th:fragment="transaction-modal" class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span id="modalTitleText">Nova Transação</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form th:action="@{/transactions}" method="post" novalidate>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Transaction Type -->
                        <div class="col-12">
                            <label for="transactionType" class="form-label fw-bold">
                                <i class="bi bi-arrow-left-right me-1"></i>Tipo de Transação
                            </label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="type" id="typeEntrada" value="ENTRADA" checked>
                                <label class="btn btn-outline-success" for="typeEntrada">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Entrada
                                </label>

                                <input type="radio" class="btn-check" name="type" id="typeSaida" value="SAIDA">
                                <label class="btn btn-outline-danger" for="typeSaida">
                                    <i class="bi bi-arrow-down-circle me-1"></i>Saída
                                </label>
                            </div>
                        </div>

                        <!-- Value and Date Row -->
                        <div class="col-md-6">
                            <label for="transactionValue" class="form-label fw-bold">
                                <i class="bi bi-currency-dollar me-1"></i>Valor
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number"
                                       class="form-control"
                                       id="transactionValue"
                                       name="value"
                                       placeholder="0,00"
                                       step="0.01"
                                       min="0.01"
                                       required>
                                <div class="invalid-feedback">
                                    Por favor, informe um valor válido.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="transactionDate" class="form-label fw-bold">
                                <i class="bi bi-calendar me-1"></i>Data
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="transactionDate"
                                   name="date"
                                   required>
                            <div class="invalid-feedback">
                                Por favor, selecione uma data.
                            </div>
                        </div>

                        <!-- Category -->
                        <div class="col-12">
                            <label for="transactionCategory" class="form-label fw-bold">
                                <i class="bi bi-tags me-1"></i>Categoria
                            </label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="transactionCategory" name="categoryId" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option th:each="category : ${categories}"
                                            th:value="${category.id}"
                                            th:text="${category.name}">
                                        Categoria
                                    </option>
                                </select>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#categoryModal"
                                        title="Nova categoria">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Por favor, selecione uma categoria.
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="col-12">
                            <label for="transactionDescription" class="form-label fw-bold">
                                <i class="bi bi-file-text me-1"></i>Descrição
                            </label>
                            <textarea class="form-control"
                                      id="transactionDescription"
                                      name="description"
                                      rows="3"
                                      placeholder="Descreva a transação (opcional)"
                                      data-auto-resize></textarea>
                        </div>

                        <!-- Recurring Transaction (Optional) -->
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isRecurring" name="isRecurring">
                                <label class="form-check-label fw-bold" for="isRecurring">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    Transação recorrente
                                </label>
                            </div>

                            <div class="row g-2 mt-2" id="recurringOptions" style="display: none;">
                                <div class="col-md-6">
                                    <select class="form-select form-select-sm" name="recurringType">
                                        <option value="MONTHLY">Mensal</option>
                                        <option value="WEEKLY">Semanal</option>
                                        <option value="YEARLY">Anual</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="number"
                                           class="form-control form-control-sm"
                                           name="recurringCount"
                                           placeholder="Quantidade de repetições"
                                           min="1" max="12">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Salvar Transação
                    </button>
                </div>

                <!-- CSRF Token -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                <input type="hidden" id="transactionId" name="id" value="">
            </form>
        </div>
    </div>
</div>

<!-- Category Quick Add Modal -->
<div th:fragment="category-modal" class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">
                    <i class="bi bi-tag me-2"></i>Nova Categoria
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="categoryQuickForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label fw-bold">Nome da Categoria</label>
                        <input type="text"
                               class="form-control"
                               id="categoryName"
                               name="name"
                               placeholder="Ex: Alimentação, Transporte, etc."
                               required>
                        <div class="invalid-feedback">
                            Por favor, informe o nome da categoria.
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus me-1"></i>Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:fragment="transaction-modal-js">
    document.addEventListener('DOMContentLoaded', function() {
        const transactionModal = document.getElementById('transactionModal');
        const categoryModal = document.getElementById('categoryModal');
        const recurringCheckbox = document.getElementById('isRecurring');
        const recurringOptions = document.getElementById('recurringOptions');

        // Set current date as default
        const dateInput = document.getElementById('transactionDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }

        // Handle recurring transaction toggle
        if (recurringCheckbox && recurringOptions) {
            recurringCheckbox.addEventListener('change', function() {
                recurringOptions.style.display = this.checked ? 'block' : 'none';
            });
        }

        // Handle transaction type change
        document.querySelectorAll('input[name="type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const modalTitle = document.getElementById('modalTitleText');
                if (modalTitle) {
                    modalTitle.textContent = this.value === 'ENTRADA' ? 'Nova Entrada' : 'Nova Saída';
                }
            });
        });

        // Transaction form submission
        const transactionForm = transactionModal?.querySelector('form');
        if (transactionForm) {
            transactionForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const submitBtn = this.querySelector('button[type="submit"]');
                FinanceApp.ui.disableButton(submitBtn);

                try {
                    const formData = FinanceApp.form.serialize(this);
                    const response = await FinanceApp.http.post('/api/transactions', formData);

                    if (response && response.ok) {
                        bootstrap.Modal.getInstance(transactionModal).hide();
                        FinanceApp.ui.showAlert('Transação salva com sucesso!', 'success');

                        // Reload page or update UI
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        const error = await response.text();
                        FinanceApp.ui.showAlert('Erro ao salvar transação: ' + error, 'danger');
                    }
                } catch (error) {
                    FinanceApp.ui.showAlert('Erro de conexão. Tente novamente.', 'danger');
                } finally {
                    FinanceApp.ui.enableButton(submitBtn);
                }
            });
        }

        // Category quick add form
        const categoryForm = document.getElementById('categoryQuickForm');
        if (categoryForm) {
            categoryForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const submitBtn = this.querySelector('button[type="submit"]');
                FinanceApp.ui.disableButton(submitBtn);

                try {
                    const formData = FinanceApp.form.serialize(this);
                    const response = await FinanceApp.http.post('/api/categories', formData);

                    if (response && response.ok) {
                        const newCategory = await response.json();

                        // Add to select
                        const categorySelect = document.getElementById('transactionCategory');
                        if (categorySelect) {
                            const option = document.createElement('option');
                            option.value = newCategory.id;
                            option.textContent = newCategory.name;
                            option.selected = true;
                            categorySelect.appendChild(option);
                        }

                        bootstrap.Modal.getInstance(categoryModal).hide();
                        FinanceApp.ui.showAlert('Categoria criada com sucesso!', 'success');

                        // Reset form
                        this.reset();
                        this.classList.remove('was-validated');
                    } else {
                        const error = await response.text();
                        FinanceApp.ui.showAlert('Erro ao criar categoria: ' + error, 'danger');
                    }
                } catch (error) {
                    FinanceApp.ui.showAlert('Erro de conexão. Tente novamente.', 'danger');
                } finally {
                    FinanceApp.ui.enableButton(submitBtn);
                }
            });
        }

        // Reset forms when modals are hidden
        transactionModal?.addEventListener('hidden.bs.modal', function() {
            const form = this.querySelector('form');
            if (form) {
                FinanceApp.form.reset(form);
                // Reset to current date
                const dateInput = form.querySelector('#transactionDate');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }
        });

        categoryModal?.addEventListener('hidden.bs.modal', function() {
            const form = this.querySelector('form');
            if (form) {
                FinanceApp.form.reset(form);
            }
        });
    });
</script>

</html>